# Выбор и настройка мониторинга в системе

## Мотивация

- Рост нагрузки и жалобы клиентов указывают на слепые зоны. Без наблюдаемости мы узнаем о проблемах от пользователей, а не из системы
- Мониторинг позволит раннее обнаружение сбоев, обнаружение проблем производительности, снижение операционных рисков и потерь выручки
- Ценность для бизнеса - сокращение просрочек, уменьшение оттока партнёров, предсказуемость релизов и способность безопасно масштабировать продажи

## Выбор подхода к мониторингу

- Для сетевые и API‑сервисов (Shop API, CRM API, MES API) будем использовать подход - "Четыре золотых сигнала" (латентность, трафик, ошибки, насыщение)
- Для RabbitMQ и фоновой обработки - RED (Rate, Errors, Duration).
- Для инфраструктуры БД и хранилищ - USE (Utilization, Saturation, Errors) для CPU, памяти, диска, коннектов, репликации

## Метрики

- `Number of dead-letter-exchange letters in RabbitMQ`
  Мониторинг ошибок обработки сообщений в очереди. Возможность настройки алерта при росте и старении DLQ
  Ярлыки: `queue`, `routing_key`, `service`, `env`.
- `Number of message in flight in RabbitMQ`
  Мониторинг загрузки потребителей и риск таймаутов
  Ярлыки: `queue`, `service`, `consumer_group`, `env`.
- `Глубина очереди (queue_depth)`
  бэклог задач и задержки
  Ярлыки: `queue`, `env`
- `Время сообщения в очереди (queue_wait_seconds p95/p99)`
  Мониторинг латентности асинхронных процессов
  Ярлыки: `queue`, `env`
- `Number of requests (RPS) (shop API/CRM API/MES API)`
  Мониторинг производительности вер-сервиса
  Ярлыки: `endpoint`, `method`, `env`.
- `Response time (latency) (shop API/CRM/MES API)`
  Мониторинг пользовательского восприятие скорости отклика
  Ярлыки: `endpoint`, `method`, `env`.
- `Number of HTTP 500 (shop/CRM/MES API)`
  Мониторинг "здоровья" приложений, Возможность настройки алертов по ошибкам
  Ярлыки: `endpoint`, `error`, `env`
- `Number of HTTP 200 (shop/CRM/MES API)`
  Контроль успешных ответов и доли ошибок
  Ярлыки: `endpoint`, `env`
- `Number of requests (RPS) per user (shop/CRM/MES API)`
  Мониторинг и выявление аномалий (злоупотреблений), тарифирование
  Ярлыки: `user_id`, `client_id`, `env`
- `Number of simultanious sessions (shop/CRM/MES API)`
  Мониторинг одновременных сессий
  Ярлыки: `app`, `env`, `region`
- `Kb transferred/received & Kb provided (sent) (shop/CRM/MES API)`
  Мониторинг пропускной способности, подсчет стоимости трафика, выявление аномалии.
  Ярлыки: `endpoint`, `method`, `env`
- `CPU % for shop/CRM/MES API`
  Мониторинг нагрузки на CPU
  Ярлыки: `instance_id`, `app`, `env`
- `Memory Utilisation shop/CRM/MES API`
  Мониторинг утечки памяти (OOM)
  Ярлыки: `instance_id`, `app`, `env`
- `Memory Utilisation for shop db instance / MES db instance`
  Мониторинг загрузки БД и вероятности свопа
  Ярлыки: `db`, `env`
- `Number of connections for shop db instance / MES db instance`
  Мониторинг исчерпания пулов и возможных ошибок подключений
  Ярлыки: `db`, `app`, `env`
- `Size of shop db instance / MES db instance`
  Мониторинг объема БД, своевременное планирование увеличение объема или архивирования.
  Ярлыки: `db`, `env`
- `Replication lag of shop db instance / MES db instance`
  Мониторинг репликаии и распределения нагрузки
  Ярлыки: `db`, `role`, `env`
- `Size of S3 storage`
  Мониторинг файлового хранилища, планирование увеличения и ретеншн‑политик
  Ярлыки: `bucket`, `file_type`, `env`

## План действий

- Развернуть стек мониторинга Prometheus, Alertmanager, Grafana
- Подключить экспортёры rabbitmq_exporter, postgres_exporter, node_exporter, включить application‑метрики и экспортер в Prometheus.
- Создать дашборды:
  • Для API "четыре сигнала" по каждому сервису с алертам
  • Для RabbitMQ - глубина/время в очереди, DLQ, in‑flight, ack/nack, потребители
  • Для баз данных - утилизация, коннекты, медленные запросы, лаг реплик
- Настроить алерты по DLQ, ошибкам 5xx, latency p95, глубине очереди, утилизации CPU/Memory, репликационному лагу, S3 ошибкам
- Интегрировать оповещения Slack/Telegram/Email, эскалации и ротации, отключения на время мейнтенансов
- Обучение команды

## Показатели насыщенности, пороги и реакции

- RabbitMQ очереди
  Порог: к примеру `queue_depth > 5000` в течение 5 минут ИЛИ `queue_wait_seconds_p95 > 120` секунд.
  Почему: рост бэклога означает, что потребители не успевают
  Действия: увеличение воркеров, уведомление команды, возможно временный rate limiting для партнёров, создание инцидента и тикета на анализ причины

- DLQ
  Порог: `count > 100` ИЛИ рост `> 10/мин` 5 минут подряд.
  Почему: деградация контрактов/данных.
  Действия: оповещение с "звонилкой", создание инцидента, автопометка проблемных сообщений

- API пул соединений к БД
  Порог: `db_connections_used > 0.8 * max_connections`
  Почему: близость к исчерпанию ресурса приводит к ошибкам и росту латентности
  Действия: увеличить пул/реплики, перевести тяжёлые чтения на реплики, включить кэш/материализованные представления, создать тикет на оптимизацию запросов

- CPU и память приложений
  Порог: `cpu_utilization > 75%` ИЛИ `memory_utilization > 85%`
  Почему: приближение к насыщению приводит к очередям запросов и OOM.
  Действия: увеличение инстансов, оповещение команды, создание тикета на устранение утечек

- Репликационный лаг БД
  Порог: `replication_lag > 30` секунд 5 минут.
  Почему: устаревшие данные при чтении, нарушение консистентности отображения статусов
  Действия: ограничить трафик на реплики, добавить реплики, анализ долгих запросов, уведомление команды и создание тикета

- Размер хранилищ
  Порог: `db_size > 80%` ИЛИ `s3_size > 80%`
  Почему: риск остановки записи и резкого роста затрат
  Действия: внедрение политики архивирование 3D‑файлов, партиционирование и очистка, возможно экстренное расширение объема дискового пространства

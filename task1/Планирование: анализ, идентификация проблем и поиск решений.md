Планирование: анализ, идентификация проблем и поиск решений

# Проблемы:

- Клиенты жалуются менеджерам по продажам, что они не получили заказ и над их изделием работают уже несколько месяцев,
  хотя обещали закончить за три недели и это не связано с производственными мощностями.

- Участились жалобы от операторов: когда они заходят на первую страницу MES, система долго прогружается.
  На первой странице отображается список заказов в работе по статусам — это дашборд с фильтром.
  Раньше страница показывала все заказы, но это тормозило загрузку.
  Команда сделала фильтр по статусам и пагинацию, но это не помогло.

# Возможные причины

## Согласованность данных

- Заказы создаются/меняются в 3х системах (онлайн‑магазин, CRM, MES), здесь высокий риск потери/дублирования данных, расхождения статусов и т.д.
- Нет единого источника истины состоянию заказа. Есть несколько баз данных в которых хранятся данные, скорее всего нарушена согласованность между ними

## Производительность

- Возможно приложения и БД развёрнуты по одному инстансу и отсутствует горизонтальное масштабирования, что приводит к росту нагрузки приводит к очередям и таймаутам
- Расчёт стоимости в MES занимает от 2х до 30ти минут. Если расчет производиться синхронно, то это может быть причиной потери заказов (например из-за таймаута).
- MES dashboard медленный. Cписок заказов в работе грузится долго даже с пагинацией и фильтром. Возможные это из-за не оптимальных запросов с тяжелыми JOIN-нами и сортировками, отсутствие индексов, отсутствие кэширования.
- БД на запись/чтение в один инстанс, нет реплик для разгрузки чтений, нет партиционирования/индексации под горячие запросы.

## Процессы и контроль качества

- Релизы в release/prod вручную, высокий цикл обратной связи, регрессии ловятся поздно
- Нет системы мониторинга. Жалобы видим от пользователей, а не из мониторинга.

## API

- Публичный API, возможно, не ограничен квотами, неформализованы SLA/ответы при асинхронной обработке. Возможно нет вебхуков/коллбеков статусов, партнёры скорее всего используют polling или ждут синхронного ответа.

# Решения

- Внедрить шаблон outbox/inbox для всех продьюсеров/консумеров событий с гарантия at‑least‑once, реализовать идемпотентные обработчики
- Включить DLQ (Dead Letter Queue), реализовать механизмы retry и backoff
- Выделить отдельный Order Service для оркестрациии заказа
- Перевести расчёт стоимости в асинхронные задачи, добавить отдельные воркеры
- Добавление rate лимитов, throttling, реализовать circuit‑breaker
- Асинхронное взаимодействие с партнерами, сразу возвращать идентификатор задачи и давать вебхуки/эндпоинт статуса
- Добавление индексов и оптимизация запросов
- Добавить кэширование запросов
- Добавить read‑реплики для нагруженных чтений из БД
- Внедрение мониторинга во все сервисы, централизованные логирование, метрики (Prometheus), дашборды и алерты (Grafana). Трассировка сквозных вызовов и сообщений
- Внедрение канареечных blue‑green деплоев, автоматизация релизов

# Целевая архитектура

- Сервисы:
  - Shop API
  - CRM API
  - MES API
  - Order Service (владелец статусов)
  - Pricing Workers
  - 3D file Processing
  - фронтенды CRM и MES
- RabbitMQ с DLQ и мониторингом
- базы данных Postgres с primary и read‑репликами
- мониторинг сервисов с prometheus и grafana

# Основные 3 пункта на ближайщие полгода

1. Мониторинг. Позволит выявить основные проблемы системы и спланировать дальнейшией шаги по улучшению

2. Асинхронный расчет цены с воркерами и лимитами в API для партнёров
   Возможно это главный источник нагрузки и задержек

3. Оптимизация MES dashboard - добавление индексов, read реплик и кэширования
   Даст мгновенную отдачу по UX и производительности.
